
****************************************************************************************
* THIS PROGRAM COMPUTES POVERTY VULNERABILITY SCENARIOS FOR BOLIVIA HOUSEHOLD SURVEY (EH)
* INPUT: EH PERSONAS 
* AUTHOR: RONALD ALONSO CUEVA 
* LAST UPDATE: 03/24/20
****************************************************************************************

set more off 
pause on

global in "/Volumes/LaCie/World Bank /Bolivia/1. Encuestas /Encuestas de Hogares /BASES MODIFICADAS" 
global out "/Volumes/LaCie/World Bank /Bolivia/Poverty Update/Outputs" 


foreach year of numlist 2018 {

/*
*** Income Variables & Related Description *** 

yprilab -> Main occupation labor income
yseclab -> Secondary occupation labor income
ylab -> Total labor income 
ynolab -> Total non labor income
yper -> Total personal income
yhog -> Household income 
yhogpc -> Household income per capita 
z -> poverty line
zext -> extreme poverty line 
p0 -> poverty headcount (dummy) 
pext0 -> extreme poverty headcount (dummy) 
phrs -> hours worked in primary occupation (weekly)
shrs -> hours worked in secondary occupation (weekly)
tothrs  -> total hours worked (weekly) 

All monetary variables are in current prices (2018). 
*/

***************
*   Do-File   * 
***************


*** Vulnerability  *** 
foreach dpt of numlist 1/9 { 
foreach days of numlist 0 8 16 24 32 40 {
		use "$in/EH_`year'_nonlabor.dta", clear
		gen year = `year'
		egen ylab2 = rowtotal(yprilab yseclab), missing 						/*Reconstructing total labor income*/ 
		
		if ylab2 > 0 {
		gen inc_ph = ylab2/(tothrs*4.3) if ylab2 > 0							/*Hourly wage*/ 
		gen vulnerability_measure = inc_ph*`days'
		gen ylab3 = ylab2-vulnerability_measure
		replace ylab3 = 0 if ylab3 < 0 
		}
		
		else if ylab2 == 0 {
		gen ylab3 = ylab2
		}
		
		egen ylab_hog = total(ylab3), by (folio) 								/*HH labor income*/ 					
		egen ynolab_hog = total(ynolab), by (folio) 							/*HH non labor income*/ 

		egen yhog_2 = rowtotal(ylab_hog ynolab_hog)  
		
		egen hh_size=count(nro), by(folio)										/*Constructing HH size*/ 
		gen ylabhog_pc = ylab_hog/hh_size 										/*HH labor income per capita*/ 
		gen ynolabhog_pc = ynolab_hog/hh_size									/*HH non-labor income per capita*/ 

		egen yhog_pc = rowtotal(ylabhog_pc ynolabhog_pc), missing 				/*Household income per capita*/ 

		gen yhog_pc2 = yhog_2/hh_size 

		gen dif5 = yhog_pc - yhog_pc2
		
		keep factor yhog_2 ylab_hog ynolab_hog  yhog_pc ylabhog_pc ynolabhog_pc z zext area upm  estrato folio year factor depto 

***************************				
**** Poverty Headcount **** 
***************************
	
	gen poor = 1 if yhog_pc < z 
	replace poor = 0 if poor == . 

	gen poor_ext = 1 if yhog_pc < zext 
	replace poor_ext = 0 if poor_ext == . 

	keep if depto == `dpt' 
	
	svyset upm [pw=factor], strata(estrato)
	svy: tab poor 
	matrix C = e(b)
	matrix A`days' = C[1,2]
	svy: tab poor_ext
	matrix D = e(b)
	matrix B`days' = D[1,2]
	
	}
	clear 
	matrix A = (A0,A8,A16,A24,A32,A40)
	matrix B = (B0,B8,B16,B24,B32,B40)
	
	svmat A
	svmat B
	export excel A* B* using "$out\Vulnerability.xlsx", sheetmodify firstrow(variables) cell(B3) sheet("D`dpt''")
	
	}
	}
	



		
		
		
		
		

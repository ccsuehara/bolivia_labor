---
title: "Further analysis on Bolivia"
author: "Rui Su"
# date: "3/29/2021"
output:
  beamer_presentation:
    colortheme: "seagull"
    fonttheme: "structurebold"
---

```{r setup, include = F}
library(tidyverse)
library(knitr)
library(stargazer)
library(kableExtra)
library(ggridges)
# library(DescTools)

# source("EDA.R")
personas <- read.csv("data/personas.csv")
adults <- personas %>%
  filter(age %in% 25:60) %>%
  select(folio, nro, relation, depto, area, sex, age, language_1, marital, literate, num_literate, indigenous, indigenous_id,
         edu, any_ed, higher_ed, in_school, why_not_in_school, current_edu, in_attendance, why_absence, education, is_student,
         chronic_disease_1, disability, pregnant, num_alive_child,
         manual_labor,
         cellphone, internet_use, internet_use_where_1, internet_use_where_2,
         emp_status,
         primary_job, work_type, primary_work_week_hr,
         primary_salary, primary_salary_freq, primary_nonsalaried_income, primary_nonsalaried_income_freq, primary_monthly_inc,
         sec_job, sec_employer_industry, sec_work_type, sec_work_week_hr,
         sec_salary, sec_salary_freq, sec_nonsalaried_income, sec_nonsalaried_income_freq, sec_monthly_inc,
         lab_monthly_inc, tot_work_week_hr, hh_lab_inc, hh_lab_inc_pct, hh_hr, hh_hr_pct, want_work_more, avail_work_more, union_member,
         sp_monthly_inc, extra_monthly_inc, dom_trans_monthly_inc, intl_remit_monthly_inc, nonlab_monthly_inc, tot_monthly_inc,
         hh_sp_inc, hh_sp_inc_pct, hh_nonlab_inc, hh_nonlab_inc_pct, hh_tot_inc, hh_tot_inc_pct, pc_inc, size, rest_of_hh,
         factor, looked_for_work) %>%
  mutate(paid = ifelse(str_detect(work_type, "^[78]"), "unpaid", "paid"))

adults_r <- adults %>% filter(area == "Rural")
adults_u <- adults %>% filter(area == "Urbana")
```

## Motivations

- Elaborate further on the rural/urban pillar
    - How does the rural/urban divide play out in one's lifetime?
    - When is the inflection point, if any? Does the impact of geography come earlier in life, during one's education, or manifest later, when one enters the workforce?
- Does the generational cycle of poverty really exist? How can we answer this question with cross-sectional data?
- What is the connection between the social class pillar and (in)formal employment? Disentangle the mutual influence between (in)formality and income

## Main components

- Wage premium of higher education between rural and urban areas
- Differences between rural households with and without domestic remittances, which are presumed to come from family members in cities
- Different generations' incomes in multi-generational households
- Incomes of individuals working in formal vs. informal jobs

# Wage premium of higher education between rural and urban areas

## Percentage of adults with higher education

```{r he, echo = F, fig.show = "hold", fig.align = "center", fig.height = 11, out.width = "48%"}
pct_he <- function(df) {
  tot <- nrow(df)
  he <- sum(df$education == "Tertiary")
  he / tot * 100
}
pct_he_r <- pct_he(adults_r)   #0.097
pct_he_u <- pct_he(adults_u)   #0.370

ggplot(data.frame(area = c("rural", "urban"), pct = c(pct_he_r, pct_he_u))) +
  geom_col(aes(area, pct, fill = area), width = 0.5) +
  theme_minimal() +
  labs(y = "% adults with higher ed degree", x = "", title = "There is a large gap in higher ed attainment between\nrural and urban areas") +
  theme(panel.grid.minor = element_blank(), legend.position = "none", text = element_text(size = 20))

# by contrast, pct adults with secondary ed has a much smaller gap
pct_se <- function(df) {
  tot <- nrow(df)
  se <- sum(df$education == "Secondary")
  se / tot * 100
}
pct_se_r <- pct_se(adults_r)   #0.350
pct_se_u <- pct_se(adults_u)   #0.427

ggplot(data.frame(area = c("rural", "urban"), pct = c(pct_se_r, pct_se_u))) +
  geom_col(aes(area, pct, fill = area), width = 0.5) +
  theme_minimal() +
  labs(y = "% adults with secondary ed degree", x = "", title = "By contrast, the gap in secondary education is much smaller") +
  theme(panel.grid.minor = element_blank(), legend.position = "none", text = element_text(size = 20))

```

## LFP rates among adults with higher ed, by area

```{r lfp, echo = F}
pct_lfp <- function(df) {
  tot <- nrow(df)
  lfp <- sum(!is.na(df$primary_job)) + sum(df$looked_for_work == "1. Si", na.rm = T)
  lfp / tot * 100
}
pct_lfp_he_r <- pct_lfp(adults_r %>% filter(education == "Tertiary"))   #0.932
pct_lfp_nohe_r <- pct_lfp(adults_r %>% filter(education != "Tertiary"))
pct_lfp_he_u <- pct_lfp(adults_u %>% filter(education == "Tertiary"))   #0.776
pct_lfp_nohe_u <- pct_lfp(adults_u %>% filter(education != "Tertiary"))

ggplot(data.frame(area = c("rural", "rural", "urban", "urban"),
                  he = c("w/higher ed", "w/o higher ed", "w/higher ed", "w/o higher ed"),
                  pct = c(pct_lfp_he_r, pct_lfp_nohe_r, pct_lfp_he_u, pct_lfp_nohe_u))) +
  geom_col(aes(pct, area, fill = he), width = 0.5, position = "dodge") +
  theme_minimal() +
  labs(x = "% adults in labor force", y = "", subtitle = "", fill = "") +
  theme(panel.grid.minor = element_blank(), legend.position = "bottom")

```

## Average labor earning by higher ed status and area

```{r lab_inc, echo = F}
avg_lab <- function(df) {
  df <- df %>% filter(!is.na(primary_job))
  tot_earn <- sum(df$lab_monthly_inc, na.rm = T)
  tot_earn / nrow(df)
}
avg_lab_he_r <- avg_lab(adults_r %>% filter(education == "Tertiary"))    #4419
avg_lab_nohe_r <- avg_lab(adults_r %>% filter(education != "Tertiary"))  #2315
avg_lab_he_u <- avg_lab(adults_u %>% filter(education == "Tertiary"))    #5045
avg_lab_nohe_u <- avg_lab(adults_u %>% filter(education != "Tertiary"))  #4582

ggplot(data.frame(area = c("rural", "rural", "urban", "urban"),
                  he = c("w/higher ed", "w/o higher ed", "w/higher ed", "w/o higher ed"),
                  pct = c(avg_lab_he_r, avg_lab_nohe_r, avg_lab_he_u, avg_lab_nohe_u))) +
  geom_col(aes(pct, area, fill = he), width = 0.5, position = "dodge") +
  theme_minimal() +
  labs(x = "average monthly labor income (BOB)", y = "", subtitle = "", fill = "") +
  theme(panel.grid.minor = element_blank(), legend.position = "bottom")

```

# Inflection point: when rural residents migrate to cities?

## Rural households with and without domestic remittances

- Households receiving domestic remittances are poorer and not that much smaller
- The recipients do not work much less because of the remittances, as there is no difference in LFP rates and only a small gap in average work hours

```{r remit_r, echo = F, results = 'asis', message = F}
remit_subset <- function(df) {
  df %>%
  group_by(folio) %>%
  summarize(nadults = n(), hhsize0 = dplyr::first(size), remit = sum(dom_trans_monthly_inc), inc = dplyr::first(hh_tot_inc), 
            lfp = sum(!is.na(primary_job) | looked_for_work == "1. Si"), lfp_paid = sum(!is.na(lab_monthly_inc) & lab_monthly_inc > 0),
            working = sum(!is.na(primary_job)), work_hr = sum(tot_work_week_hr, na.rm = T)) %>%
  mutate(has_remit = remit != 0) %>%
  group_by(has_remit) %>%
  summarize(nhh = n(), n = sum(hhsize0), hhsize = mean(hhsize0) %>% round(2), nadults = sum(nadults), remit = mean(remit) %>% round(), pc_inc = sum(inc),
            inc = mean(inc) %>% round(), lfp = sum(lfp), lfp_paid = sum(lfp_paid), working = sum(working), work_hr = sum(work_hr)) %>%
  mutate(work_hr = round(work_hr / working, 1), lfp = round(lfp / nadults * 100, 1), lfp_paid = round(lfp_paid / nadults * 100, 1),
         pc_inc = round(pc_inc / n)) %>%
  select(-nadults, -n, -working)
}

remit_r <- remit_subset(adults_r)

knitr::kable(remit_r, caption = "Rural households by remittance", align = "c") %>% kable_styling(font_size = 8)

```

## Examine the assumption: which way do remittances flow?

```{r remit_ru, echo = F, results = 'asis'}
remit_u <- remit_subset(adults_u)

knitr::kable(remit_r, caption = "Rural households by remittance") %>% kable_styling(font_size = 8)
knitr::kable(remit_u, caption = "Urban households by remittance") %>% kable_styling(font_size = 8)
```

16% of rural households and 12% of urban households receive domestic remittances

## Examine a deeper assumption: what is rural, what is urban?

- Bolivia's definition of "urban": Localities with 2,000 inhabitants or more (UN, *World Urbanization Prospects*, 2011)
    - The way a "locality's" boundary is drawn can determine whether it counts as urban or rural
- While on paper it seems like 80% of adults live in urban areas (EH 2018), trends like peri-urbanization, expansive urban growth, and diffusion of urban form in villages blur the rural-urban boundaries (O'Hare & Rivas 2007)

<!-- ![city of El Alto](www/el_alto.jpg) ![a village in La Paz department](www/ichoka.jpg) -->

```{r ru_def, echo = F, fig.show = "hold", out.width = "48%", fig.align = "default"}
knitr::include_graphics("www/el_alto.jpg")
knitr::include_graphics("www/ichoka.jpg")
```

## Examine a deeper assumption: what is rural, what is urban?

- We don't know which way the remittances really flow
- The summary statistics on households w/remittances could change if the threshold of rural/urban is moved
- Moreover, this calls into question the rural/urban pillar itself

## Another look: there are still differences

```{r remit_ru2, echo = F, results = 'asis'}
knitr::kable(remit_r, caption = "Rural households by remittance") %>% kable_styling(font_size = 8)
knitr::kable(remit_u, caption = "Urban households by remittance") %>% kable_styling(font_size = 8)
```

- Remittances are higher among urban households
- Inflection point: **higher education**

## Who are the migrants?

```{r migrant, echo = F, message = F}
adults_he <- adults %>%
  mutate(he = ifelse(education == "Tertiary", "w/higher ed", "w/o higher ed")) %>%
  group_by(area, he) %>%
  summarize(pc_inc = mean(pc_inc), size = mean(size))

ggplot(adults_he) +
  geom_col(aes(pc_inc, area, fill = he), width = 0.5, position = "dodge") +
  theme_minimal() +
  labs(x = "average household per capita monthly income (BOB)", y = "", subtitle = "", fill = "") +
  theme(panel.grid.minor = element_blank(), legend.position = "bottom")

```

People without higher ed come from poorer families, aka families that are more likely to have remittances

## Who are the migrants?

```{r migrant1, echo = F, message = F, warning = F}
adults %>%
  group_by(folio) %>%
  summarize(area = dplyr::first(area), remit = sum(dom_trans_monthly_inc), pc_inc = dplyr::first(pc_inc)) %>%
  mutate(has_remit = ifelse(remit != 0, "w/remits", "w/o remits")) %>%
  ggplot() +
  geom_boxplot(aes(has_remit, pc_inc, fill = has_remit), width = 0.5, alpha = 0.5) +
  facet_wrap("area") +
  theme_minimal() +
  ylim(0, 10000) + xlab("") + ylab("per capita monthly income (BOB)") +
  theme(panel.grid.minor = element_blank(), legend.position = "none")
```

## Who are the migrants?

```{r migrant2, echo = F, message = F}
ggplot(adults_he) +
  geom_col(aes(size, area, fill = he), width = 0.5, position = "dodge") +
  theme_minimal() +
  labs(x = "average household size", y = "", subtitle = "", fill = "") +
  theme(panel.grid.minor = element_blank(), legend.position = "bottom")
```

People without higher ed come from slightly larger families, who are more likely to produce surplus labor who flows to cities

## Who are the migrants?

```{r migrant3, echo = F, message = F}
adults %>%
  group_by(folio) %>%
  summarize(area = dplyr::first(area), remit = sum(dom_trans_monthly_inc), women = mean(sex == "2.Mujer") * 100) %>%
  mutate(has_remit = remit != 0) %>%
  group_by(has_remit, area) %>%
  summarize(women = mean(women)) %>%
  ggplot() +
  geom_col(aes(women, area, fill = has_remit), width = 0.5, position = "dodge") +
  theme_minimal() +
  labs(x = "% women or girls", y = "", fill = "receives remittances") +
  theme(panel.grid.minor = element_blank(), legend.position = "bottom")
```

Think: women and girls also tend to be the ones doing unpaid labor

## Connect the dots: extrapolate a "typical" migrant

- From a poor household in need of extra income
- A man
- Without higher education
- There are enough hands at home for subsistence farming or other unpaid family-based productive activities
- Drawn to lucrative jobs in the cities
    - Remember that even someone without a college degree in cities earns a bit more than someone with a college degree in villages
- Make it in the city? How does he stack up against other migrants from (smaller) urban areas, who are more likely to be college educated?  
  
- Migration flow: rural villages --> small cities --> large cities

## The bottom line

- The (first) inflection point comes earlier in life, in higher education attainment
- While the premium for higher ed is high in rural areas, the educational opportunities are low: only <10% go to university
- The disadvantage in education is manifested later on whether one migrates to cities or stays in the countryside and takes on low-paid jobs
- But the educational discrepancy is also a structural issue, where university is reserved for the rich

# Generational cycle of poverty

## Sample

- To investigate inter-generational effects, I filtered for multigenerational households, defined as households with at least two generations of **adults between 25 and 60**
- This subset includes 3462 adults from 1523 households, representing 21.8% of all adults sampled in the household survey

## Overall social mobility: education

Educational attainment has improved significantly between generations

```{r gen_ed, echo = F, message = F}
# Filter for households with adult children (non-HoH)
hh_adult_child <- adults %>%
  filter(str_detect(relation, "^3")) %>%
  pull(folio) %>% unique()

adults_2gen1 <- adults %>%
  filter(folio %in% hh_adult_child) %>%
  filter(!str_detect(relation, "10") & !str_detect(relation, "11") & !str_detect(relation, "^[589]")) %>%
  mutate(gen = ifelse(str_detect(relation, "^[34]"), "younger", "older"))

# Filter for households with adult head of household and adult parents
hh_adult_parent1 <- adults %>%
  filter(str_detect(relation, "^1") & !str_detect(relation, "^10") & !str_detect(relation, "^11")) %>%
  pull(folio) %>% unique()

hh_adult_parent2 <- adults %>%
  filter(str_detect(relation, "^6")) %>%
  pull(folio) %>% unique()

hh_adult_parent <- intersect(hh_adult_parent1, hh_adult_parent2)

adults_2gen2 <- adults %>%
  filter(folio %in% hh_adult_parent) %>%
  filter(!str_detect(relation, "10") & !str_detect(relation, "11") & !str_detect(relation, "^[589]")) %>%
  mutate(gen = ifelse(str_detect(relation, "^[12]"), "younger", "older"))

# Combine the two types of 2-generational households
adults_2gen <- rbind(adults_2gen1, adults_2gen2)

adults_2gen %>%
  group_by(folio, gen) %>%
  summarize(area = first(area), edu2 = names(sort(-table(education)))[1]) %>%
  pivot_wider(names_from = gen, values_from = edu2) %>%
  na.omit() %>%
  group_by(older, area) %>%
  summarize(less_than_primary = sum(younger == "Less than Primary"),
            primary = sum(younger == "Primary"),
            secondary = sum(younger == "Secondary"),
            tertiary = sum(younger == "Tertiary")) %>%
  pivot_longer(cols = 3:6, names_to = "younger", values_to = "count") %>%
  ggplot(aes(older, younger)) +
  geom_tile(aes(fill = count)) +
  geom_text(aes(label = count)) +
  facet_wrap("area") +
  theme_minimal() +
  scale_fill_distiller(direction = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggplot(adults_2gen) +
#   geom_bar(aes(education, fill = gen), position = "dodge", width = 0.5) +
#   # facet_wrap("sex") +
#   theme_minimal() +
#   theme(panel.grid.minor = element_blank(), legend.position = "bottom") +
#   labs(y = "", fill = "generation")

```

## Overall social mobility: employment

While educational attainment has improved, this has not resulted in a systematic increase in labor earnings

```{r gen_emp, echo = F, message = F, warning = T, fig.show = "hold", fig.align = "center", fig.height = 4}
adults_2gen %>%
  group_by(gen) %>%
  summarize(lfp = round(mean(!is.na(primary_job) | looked_for_work == "1. Si") * 100, 1),
            lfp_paid = round(mean(!is.na(lab_monthly_inc) & lab_monthly_inc > 0) * 100, 1),
            n_paid = sum(!is.na(lab_monthly_inc) & lab_monthly_inc > 0), sum_lab_inc = sum(lab_monthly_inc, na.rm = T)) %>%
  mutate(avg_lab_inc = round(sum_lab_inc / n_paid)) %>%
  select(-n_paid, -sum_lab_inc) %>%
  knitr::kable(caption = "Employment conditions by generation") %>% kable_styling(font_size = 8)

adults_2gen_inc <- adults_2gen %>%
  filter(!is.na(lab_monthly_inc)) %>%
  group_by(folio, gen) %>%
  summarize(avg_lab_inc = mean(lab_monthly_inc) + 1, area = first(area)) %>%
  pivot_wider(names_from = gen, values_from = avg_lab_inc) %>%
  na.omit() %>%
  mutate(older = log10(older), younger = log10(younger)) %>%
  filter(older > 0 & younger > 0)

fit <- lm(younger ~ older, data = adults_2gen_inc) # R-squared 0.09
fit_r <- lm(younger ~ older, data = adults_2gen_inc %>% filter(area == "Rural")) # R-squared 0.42
fit_u <- lm(younger ~ older, data = adults_2gen_inc %>% filter(area == "Urbana")) # R-squared 0.05

adults_2gen_inc %>%
  ggplot(aes(older, younger)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  facet_wrap("area", labeller = labeller(area = c("Rural" = "rural (r-squared 0.42)", "Urbana" = "urban (r-squared 0.05)"))) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) +
  labs(x = "older generation income (BOB) (log10)", y = "younger generation income (BOB) (log10)") +
  coord_fixed() +
  scale_y_continuous(breaks = c(2, 3, 4))

```

# Other exploratory stuff

## Indigenous

```{r, echo = F, message = F}
adults %>%
  filter(!startsWith(indigenous, "3")) %>%
  ggplot() +
  geom_bar(aes(education, fill = indigenous), width = 0.5, position = "fill") +
  facet_wrap("area") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())

```

## Formality
```{r, echo = F, message = F}
adults_formal <- adults %>%
  filter(!is.na(work_type) & !str_detect(work_type, "^[78]")) %>%
  mutate(formal = ifelse(str_detect(work_type, "^[12456]"), T, F))

adults_formal %>%
  ggplot() +
  geom_bar(aes(education, fill = formal), position = "fill", width = 0.5) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())
```

## Formality
```{r, echo = F, message = F}
adults_formal %>%
  group_by(area, sex, education) %>%
  summarize(n = n(), inc = mean(lab_monthly_inc, na.rm = T)) %>%
  ggplot(aes(education, inc)) +
  geom_col(aes(fill = sex), width = 0.5, position = "dodge") +
  # geom_text(aes(label = n)) +
  facet_wrap("area") +
  theme_minimal()
```

## Formality
```{r, echo = F, message = F, warning = F}
adults_formal %>%
  # group_by(area, sex, education) %>%
  # summarize(n = n(), inc = mean(lab_monthly_inc, na.rm = T)) %>%
  ggplot(aes(x = lab_monthly_inc, y = education)) +
  geom_density_ridges(aes(fill = formal, height = ..density..), stat = "density", alpha = 0.5, color = "white", scale = 1) +
  facet_wrap("area") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) +
  xlim(0, 15000)
```

## Formality
```{r, echo = F, message = F}
adults_formal %>%
  group_by(area, formal, education) %>%
  summarize(n = n(), inc = mean(lab_monthly_inc, na.rm = T)) %>%
  ggplot() +
  geom_col(aes(education, inc, fill = formal), position = "dodge", width = 0.5) +
  facet_wrap("area") +
  theme_minimal()
```

## Formality
```{r, echo = F, message = F}
adults %>%
  filter(!is.na(work_type) & !str_detect(work_type, "^[78]")) %>%
  group_by(work_type, area) %>%
  summarize(n = n(), inc = mean(lab_monthly_inc, na.rm = T)) %>%
  ggplot() +
  geom_col(aes(inc, work_type, fill = area), width = 0.5, position = "dodge") +
  theme_minimal()
```

